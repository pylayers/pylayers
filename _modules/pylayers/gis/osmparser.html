

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pylayers.gis.osmparser &mdash; PyLayers</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  

  
        <link rel="author" title="About these documents"
              href="../../../about.html"/>
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="PyLayers" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Python
          

          
            
            <img src="../../../_static/pylayers.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebook/index.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exLayout1.html">Loading an outdoor layout from its address</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_antenna.html">Antenna Pattern for an H plane sectoral antenna &#64; 32GHz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exLayout2.html">Building graphs of a Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_coverage.html">Indoor Radio Coverage with Motley Keenan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_layout.html">8 Random Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exAbsGas.html">Attenuation due to atmospheric gases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exDLink.html">Evaluation of a radio link DLink</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_w1.html">Indoor Radio Coverage FP7 WHERE1 M1 setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exLuebbers.html">UWB Ray tracing simulation  in outdoor scenario</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_diffraction.html">Diffraction coefficient</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html">1&nbsp;&nbsp;&nbsp;pylayers.util.project Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.gis.layout">2&nbsp;&nbsp;&nbsp;pylayers.gis.layout Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.gis.selectl">3&nbsp;&nbsp;&nbsp;pylayers.gis.selectl Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.gis.srtm">4&nbsp;&nbsp;&nbsp;pylayers.gis.srtm Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.gis.osmparser">5&nbsp;&nbsp;&nbsp;pylayers.gis.osmparser Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.gis.ezone">6&nbsp;&nbsp;&nbsp;pylayers.gis.ezone Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.antenna">7&nbsp;&nbsp;&nbsp;pylayers.antprop.antenna Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.aarray">8&nbsp;&nbsp;&nbsp;pylayers.antprop.aarray Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.spharm">9&nbsp;&nbsp;&nbsp;pylayers.antprop.spharm Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.antssh">10&nbsp;&nbsp;&nbsp;pylayers.antprop.antssh Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.antvsh">11&nbsp;&nbsp;&nbsp;pylayers.antprop.antvsh Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.slab">12&nbsp;&nbsp;&nbsp;pylayers.antprop.slab Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.signature">13&nbsp;&nbsp;&nbsp;pylayers.antprop.signature Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.interactions">14&nbsp;&nbsp;&nbsp;pylayers.antprop.interactions Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.diffraction">15&nbsp;&nbsp;&nbsp;pylayers.antprop.diffraction Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.diffRT">16&nbsp;&nbsp;&nbsp;pylayers.antprop.diffRT Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.rays">17&nbsp;&nbsp;&nbsp;pylayers.antprop.rays Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.loss">18&nbsp;&nbsp;&nbsp;pylayers.antprop.loss Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.channel">19&nbsp;&nbsp;&nbsp;pylayers.antprop.channel Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id39">20&nbsp;&nbsp;&nbsp;pylayers.antprop.loss Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.coverage">21&nbsp;&nbsp;&nbsp;pylayers.antprop.coverage Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.antprop.coeffModel">22&nbsp;&nbsp;&nbsp;pylayers.antprop.coeffModel Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.simul.link">23&nbsp;&nbsp;&nbsp;pylayers.simul.link Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.simul.exploit">24&nbsp;&nbsp;&nbsp;pylayers.simul.exploit Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.simul.exploit_simulnet">25&nbsp;&nbsp;&nbsp;pylayers.simul.exploit_simulnet Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.simul.simulnet">26&nbsp;&nbsp;&nbsp;pylayers.simul.simulnet Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.simul.simultraj">27&nbsp;&nbsp;&nbsp;pylayers.simul.simultraj Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.exploit.simnet">28&nbsp;&nbsp;&nbsp;pylayers.exploit.simnet Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.measures.mesuwb">29&nbsp;&nbsp;&nbsp;pylayers.measures.mesuwb Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.measures.mesmimo">30&nbsp;&nbsp;&nbsp;pylayers.measures.mesmimo Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.measures.cormoran">31&nbsp;&nbsp;&nbsp;pylayers.measures.cormoran Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.measures.vna.E5072A">32&nbsp;&nbsp;&nbsp;pylayers.measures.vna.E5072A Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.measures.parker.smparker">33&nbsp;&nbsp;&nbsp;pylayers.measures.parker.smparker Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.signal.bsignal">34&nbsp;&nbsp;&nbsp;pylayers.signal.bsignal Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.signal.standard">35&nbsp;&nbsp;&nbsp;pylayers.signal.standard Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.signal.device">36&nbsp;&nbsp;&nbsp;pylayers.signal.device Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.signal.DF">37&nbsp;&nbsp;&nbsp;pylayers.signal.DF Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.signal.waveform">38&nbsp;&nbsp;&nbsp;pylayers.signal.waveform Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.mobility.agent">39&nbsp;&nbsp;&nbsp;pylayers.mobility.agent Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#module-pylayers.mobility.ban.body">40&nbsp;&nbsp;&nbsp;pylayers.mobility.ban.body Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id136">41&nbsp;&nbsp;&nbsp;pylayers.measures.cormoran Module</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">Python</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>pylayers.gis.osmparser</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pylayers.gis.osmparser</h1><div class="highlight"><pre>
<span></span># -*- coding: utf-8 -*-
&quot;&quot;&quot;
Module OSMParser

.. currentmodule:: pylayers.gis.osmparser

.. autosummary::

&quot;&quot;&quot;
from osmapi import OsmApi
import geocoder as geo
import urllib
import urllib2 as url
from pylayers.util.project import *
import pylayers.util.pyutil as pyu
import pylayers.util.geomutil as geu
from mpl_toolkits.basemap import Basemap
from matplotlib.collections import PolyCollection
import matplotlib.pyplot as plt
# imposm is required for handling osm files
# the installation of imposm is not straightforward
try:
    from imposm.parser import OSMParser
except:
    print &quot;Warning : imposm seems not to be installed&quot;
import networkx as nx
import numpy as np
import pdb

# classes that handle the OSM data file format.
<div class="viewcode-block" id="Way"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Way.html#pylayers.gis.osmparser.Way">[docs]</a>class Way(object):
    &quot;&quot;&quot;  

    A Way is a polyline or a Polygon (if closed)

    typ : 0 Polygon
          1 LineString

    &quot;&quot;&quot;
    def __init__(self,refs,tags,coords):
        &quot;&quot;&quot; object constructor

        Parameters
        ----------

        refs  :
        tags  :
        coords :
        nodes_sign : int 
            if data comes from osm nodes are &gt;0 in ways sequence 
            if data comes from josm editor nodes are &lt;0 ways sequence

        &quot;&quot;&quot;
        self.refs  = refs
        self.tags = tags
        N = len(refs)
        p = np.zeros((2, N))
        self.valid = True
        for k, nid in enumerate(refs):
            try:
                p[0, k] = coords.xy[nid][0]
                p[1, k] = coords.xy[nid][1]
            except:
                self.valid=False
                break
        # closed way or open way
        if self.valid:
            if (N&gt;=4) &amp; (refs[0]==refs[-1]):
                self.shp = geu.Polygon(p)
                self.typ = 0
            else:
                self.shp = geu.LineString(p)
                self.typ = 1

    def __repr__(self):
        st = &#39;&#39;
        st = st + str(self.tags) + &#39;:&#39; + str(self.refs)
        return(st)

<div class="viewcode-block" id="Way.show"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Way.html#pylayers.gis.osmparser.Way.show">[docs]</a>    def show(self,fig=[],ax=[]):
        &quot;&quot;&quot; show way

        Parameters
        ----------

        fig : matplotlib figure
        ax  : axes

        &quot;&quot;&quot;
        fig,ax = self.shp.plot(fig=fig,ax=ax)
        return(fig,ax)</div></div>

<div class="viewcode-block" id="Coords"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Coords.html#pylayers.gis.osmparser.Coords">[docs]</a>class Coords(object):
    &quot;&quot;&quot; Coords describes a set of points in OSM 

    Attributes
    ----------

    xy :
    latlon :
    cpt :
    minlon :
    maxlon :
    minlat :
    maxlat :
    boundary : np.array
        (minlon,minlat,maxlon,maxlat) 

    Notes
    -----


    &quot;&quot;&quot;
    cpt = 0
    latlon = {}
    xy = {}
    minlon = 1000
    maxlon = -1000
    minlat = 1000
    maxlat = -1000
    
    def __init__(self,idx=[],latlon=[]):
        &quot;&quot;&quot;
        &quot;&quot;&quot;
        if latlon!=[]:
            for k,ix in enumerate(idx):
                self.latlon[k]=np.array(latlon[k][0],latlon[k][1])

    def __repr__(self):
        st = &#39;&#39;
        for k in self.xy:
            st = st + str(k)+ &#39;:&#39; + str(self.xy[k])+&#39;\n&#39;
        st = st+ &#39;Ncoords = &#39;+ str(len(self.xy))+&#39;\n&#39;

        return(st)
    
<div class="viewcode-block" id="Coords.filter"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Coords.html#pylayers.gis.osmparser.Coords.filter">[docs]</a>    def filter(self,lexcluded):
        for ix in lexcluded:
            self.latlon.pop(-np.abs(ix))
            self.xy.pop(-np.abs(ix))
            self.cpt-=1</div>

<div class="viewcode-block" id="Coords.clean"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Coords.html#pylayers.gis.osmparser.Coords.clean">[docs]</a>    def clean(self):
        &quot;&quot;&quot; reset coordinates

        &quot;&quot;&quot;
        self.cpt = 0
        self.latlon={}
        self.xy = {}
        self.minlon =1000
        self.maxlon =-1000
        self.minlat =1000
        self.maxlat =-1000</div>

<div class="viewcode-block" id="Coords.coords"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Coords.html#pylayers.gis.osmparser.Coords.coords">[docs]</a>    def coords(self, coords):
        &quot;&quot;&quot; calculates extrema of coords

        Parameters
        ----------

        coords

        &quot;&quot;&quot;
        # callback method for coords
        for osmid, lon, lat in coords:
            self.latlon[osmid] = np.array([lon, lat])
            # find extrema
            self.minlon = min(lon,self.minlon)
            self.maxlon = max(lon,self.maxlon)
            self.minlat = min(lat,self.minlat)
            self.maxlat = max(lat,self.maxlat)

            self.cpt += 1
        self.boundary=np.array([self.minlon,self.minlat,self.maxlon,self.maxlat])</div>

<div class="viewcode-block" id="Coords.cartesian"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Coords.html#pylayers.gis.osmparser.Coords.cartesian">[docs]</a>    def cartesian(self,cart=False,delta=0):
        &quot;&quot;&quot; convert Latitude/Longitude in cartesian

        Parameters
        ----------
        cart : Boolean 
            conversion to cartesian 
        delta : offset 
            default 0 : in this case the origin corresponds to the lower left point
 
        Notes
        -----

        This method converts latlon coordinates into cartesian x,y coordinates in
        Cassini projection relatively to specified latlon boundary 
        The basemap objet for back and forth coordinates conversion is returned.

        The transformation is centered on the mean of latitude and longitude. 
        The cartesian origin (0,0) correspond to the lower left corner (lonmin,latmin) 

        Returns
        -------

        m : Basemap converter



        Warning
        -------

        If boundary is modified cartesian coordinates change.


        &quot;&quot;&quot;
        bd = self.boundary
        lon_0 = (bd[0]+bd[2])/2.
        lat_0 = (bd[1]+bd[3])/2.

        m = Basemap(llcrnrlon=bd[0]-delta, llcrnrlat=bd[1]-delta,
                    urcrnrlon=bd[2]+delta, urcrnrlat=bd[3]+delta,
                resolution=&#39;i&#39;, projection=&#39;cass&#39;, lon_0=lon_0, lat_0=lat_0)

        for kid in self.latlon:
            if cart:
                x, y = m(self.latlon[kid][0], self.latlon[kid][1])
            else:
                x, y = (self.latlon[kid][0], self.latlon[kid][1])

            self.xy[kid]  = np.array([x,y])

        return(m)</div>

<div class="viewcode-block" id="Coords.from_nodes"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Coords.html#pylayers.gis.osmparser.Coords.from_nodes">[docs]</a>    def from_nodes(self,nodes):
        &quot;&quot;&quot; read coordinates from nodes 

        Parameters
        ----------

        nodes : Nodes 


        &quot;&quot;&quot;
        for osmid in nodes.node:
            lon = nodes.node[osmid][&#39;lonlat&#39;][0]
            lat = nodes.node[osmid][&#39;lonlat&#39;][1]
            self.latlon[osmid] = np.array([lon,lat])
            # find extrema
            self.minlon = min(lon,self.minlon)
            self.maxlon = max(lon,self.maxlon)
            self.minlat = min(lat,self.minlat)
            self.maxlat = max(lat,self.maxlat)

            self.cpt += 1
        self.boundary=np.array([self.minlon,self.minlat,self.maxlon,self.maxlat])</div></div>
        


<div class="viewcode-block" id="Nodes"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Nodes.html#pylayers.gis.osmparser.Nodes">[docs]</a>class Nodes(object):
    &quot;&quot;&quot;

    osm Nodes container

    &quot;&quot;&quot;

    node = {}
    cpt = 0

<div class="viewcode-block" id="Nodes.nodes"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Nodes.html#pylayers.gis.osmparser.Nodes.nodes">[docs]</a>    def nodes(self,nodes):
        &quot;&quot;&quot;  parse tagged nodes
        &quot;&quot;&quot;
        for osmid,tags,coords in nodes:
            self.node[osmid] = {}
            self.node[osmid][&#39;tags&#39;] = tags
            self.node[osmid][&#39;lonlat&#39;] = coords
            lon = coords[0]
            lat = coords[1]
            self.cpt += 1</div>
    
    def __repr__(self):
        st = &#39;&#39;
        for kid in self.node:
            st = st+str(kid) + &#39; : &#39; + str(self.node[kid][&#39;lonlat&#39;])+&#39;\n&#39;
        return(st)

<div class="viewcode-block" id="Nodes.clean"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Nodes.html#pylayers.gis.osmparser.Nodes.clean">[docs]</a>    def clean(self):
        self.node= {}
        self.cpt = 0</div>

<div class="viewcode-block" id="Nodes.readmap"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Nodes.html#pylayers.gis.osmparser.Nodes.readmap">[docs]</a>    def readmap(self,osmmap):
        &quot;&quot;&quot; read nodes from a map 
        &quot;&quot;&quot;
        for item in osmmap:
            if item[&#39;type&#39;]==&#39;node&#39;:
                osmid = -item[&#39;data&#39;][&#39;id&#39;]
                lon = item[&#39;data&#39;][&#39;lon&#39;]
                lat = item[&#39;data&#39;][&#39;lat&#39;]
                self.node[osmid]={}
                self.node[osmid][&#39;tags&#39;] = item[&#39;data&#39;][&#39;tag&#39;]
                self.node[osmid][&#39;lonlat&#39;] = (lon,lat)
                self.cpt += 1</div></div>

<div class="viewcode-block" id="Ways"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Ways.html#pylayers.gis.osmparser.Ways">[docs]</a>class Ways(object):
    &quot;&quot;&quot;

    Attributes
    ----------

    w : dict
    way : dict
    cpt : int
        way counter 


    Methods
    -------

    ways
    eval
    show

    &quot;&quot;&quot;
    w = {}
    way = {}
    cpt = 0

<div class="viewcode-block" id="Ways.ways"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Ways.html#pylayers.gis.osmparser.Ways.ways">[docs]</a>    def ways(self, ways):
        &quot;&quot;&quot; general callback function
        &quot;&quot;&quot;
        for osmid, tags, refs in ways:
            self.w[osmid] = [refs,tags]
            self.cpt += 1</div>

    def __repr__(self):
        st = &#39;&#39;
        for kid in self.w:
            st = st + str(self.w[kid])+&#39;\n&#39;
        return st 

<div class="viewcode-block" id="Ways.clean"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Ways.html#pylayers.gis.osmparser.Ways.clean">[docs]</a>    def clean(self):
        &quot;&quot;&quot; clean ways 
        &quot;&quot;&quot;
        self.w = {}
        self.way = {}
        self.cpt = 0</div>

<div class="viewcode-block" id="Ways.building"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Ways.html#pylayers.gis.osmparser.Ways.building">[docs]</a>    def building(self, ways , height=8.5):
        &quot;&quot;&quot; building callback function

        Parameters
        ----------

        ways : Ways
        height : float 

        &quot;&quot;&quot;
        for osmid, tags, refs in ways:
            if &#39;building&#39; in tags:
                if &#39;height&#39; in tags:
                    tags = {&#39;height&#39;:tags[&#39;height&#39;]}
                else:
                    tags = {&#39;height&#39;: height}

                self.w[osmid] = [refs,tags]
                self.cpt += 1</div>

<div class="viewcode-block" id="Ways.eval"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Ways.html#pylayers.gis.osmparser.Ways.eval">[docs]</a>    def eval(self,coords):
        &quot;&quot;&quot; convert into a Way object

        Parameters
        ----------

        coords : osm coordinates

        &quot;&quot;&quot;

        for osmid in self.w:
            refs = self.w[osmid][0]
            tags = self.w[osmid][1]
            away =  Way(refs,tags,coords)
            if away.valid:
                self.way[osmid] = away</div>

<div class="viewcode-block" id="Ways.show"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Ways.html#pylayers.gis.osmparser.Ways.show">[docs]</a>    def show(self,typ=2,**kwargs):
        &quot;&quot;&quot; show all way

        Parameters
        ----------

        fig : figure
        ax  : axe
        typ : 0|1|2 (default)
                0 : display only way of typ 0  (Polygon)
                1 : display only way of typ 1  (Linestring)
                2 : display all way (default)
        &quot;&quot;&quot;
        if &#39;fig&#39; not in kwargs:
            fig = plt.figure(**kwargs)
        else:
            fig = kwargs[&#39;fig&#39;]

        if &#39;ax&#39; not in kwargs:
            ax = fig.gca()
        else:
            ax = kwargs[&#39;ax&#39;]

        lpoly  = []
        lonmin = 360
        lonmax = -360
        latmin = 360
        latmax = -360
        for b in self.way:
            if typ==0:
                if self.way.typ==0:
                    p =ways.way[b].shp
            if typ==1:
                if self.way.typ==1:
                    p = self.way[b].shp
            if typ==2:
                p = self.way[b].shp

            lpoly.append(p)

        pdb.set_trace()
        city = PolyCollection(lpoly,closed=False)

        ax.axis((lonmin,lonmax,latmin,latmax))
        ax.add_collection(city)
        ax.autoscale_view()
        plt.axis(&#39;scaled&#39;)
        return(fig,ax)</div>

<div class="viewcode-block" id="Ways.tomaska"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Ways.html#pylayers.gis.osmparser.Ways.tomaska">[docs]</a>    def tomaska(self,m,lonlat=True):
        &quot;&quot;&quot; convert to masked array

        Parameters
        ----------

        m : Basemap object
            for converting to and from map projection coordinates
        lonlat : boolean
            returns in WGS84 format if True

        Returns
        -------

        ptma : masked array

        &quot;&quot;&quot;

        tpt  = np.empty((2,))
        mask = np.ones((2,))
        N = len(self.way.keys())
        for k,b in enumerate(self.way):
            # retrieve PolyGon or LineString
            # progress bar
            if k%1000==0:
                print k,N
            shp = self.way[b].shp
            if type(shp)==geu.Polygon:
                pa = self.way[b].shp.ndarray()
                Np = np.shape(pa)[1]
                for ip in range(Np+1):
                    tpt  = np.vstack((tpt,pa[:,ip%Np]))
                    mask = np.vstack((mask,np.array([[0,0]])))
                tpt = np.vstack((tpt,np.array([[0,0]])))
                mask = np.vstack((mask,np.array([[1,1]])))

        if lonlat:
            (lon,lat) = m(tpt[:,0],tpt[:,1],inverse=True)
            tpt = np.vstack([lon,lat]).T

        #vertices = np.ma.masked_array(tpt, mask)
        #return(vertices)
        return(tpt,mask)</div>

<div class="viewcode-block" id="Ways.showold"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Ways.html#pylayers.gis.osmparser.Ways.showold">[docs]</a>    def showold(self,fig=[],ax=[]):
        &quot;&quot;&quot; show ways

        Parameters
        ----------

        fig
        ax

        &quot;&quot;&quot;
        if fig==[]:
            fig = plt.figure()
        elif ax==[]:
            ax = fig.gca()

        for b in self.way:
            tags  = self.way[b].tags
            if (&#39;building&#39; in tags) | (&#39;buildingpart&#39; in tags):
                print &quot;buildingpart found&quot;
                try:
                    poly  = self.way[b].shp
                    if &#39;building:roof:colour&#39; in tags:
                        col = &#39;#&#39;+tags[&#39;building:roof:colour&#39;]
                    else:
                        col = &#39;#abcdef&#39;
                    fig, ax = poly.plot(fig=fig, ax=ax,color=col)
                except:
                    print &quot;building: &quot;,b,&quot; is not a polygon&quot;
        plt.axis(&#39;scaled&#39;)
        return(fig,ax)</div>

<div class="viewcode-block" id="Ways.readmap"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Ways.html#pylayers.gis.osmparser.Ways.readmap">[docs]</a>    def readmap(self,osmmap,coords,typ=&#39;building&#39;):
        &quot;&quot;&quot; read ways from a map 
        
        osmmap : OSM Map in json from OsmAPI
        coords : coords object previously parsed
        typ  : string 
            outdoor or indoor
        &quot;&quot;&quot;
        for item in osmmap:
            if item[&#39;type&#39;]==&#39;way&#39;:
                way = item[&#39;data&#39;]
                osmid = way[&#39;id&#39;]
                refs  = way[&#39;nd&#39;]
                refs_neg = [-x for x in refs]
                tags  = way[&#39;tag&#39;]
                if typ in tags:
                    self.w[osmid] = [refs_neg,tags]
                    self.cpt += 1
        
        self.eval(coords)
        pass</div></div>

<div class="viewcode-block" id="Relations"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Relations.html#pylayers.gis.osmparser.Relations">[docs]</a>class Relations(object):
    relation = {}
    cpt = 0
<div class="viewcode-block" id="Relations.relations"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Relations.html#pylayers.gis.osmparser.Relations.relations">[docs]</a>    def relations(self,rels):
        for osmid,tags,member in rels:
                self.relation[osmid]={}
                self.relation[osmid][&#39;tags&#39;]=tags
                self.relation[osmid][&#39;members&#39;]=member
                self.cpt = self.cpt+1</div>
<div class="viewcode-block" id="Relations.clean"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.Relations.html#pylayers.gis.osmparser.Relations.clean">[docs]</a>    def clean(self):
        self.relation= {}
        self.cpt = 0</div></div>

<div class="viewcode-block" id="FloorPlan"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.FloorPlan.html#pylayers.gis.osmparser.FloorPlan">[docs]</a>class FloorPlan(nx.DiGraph):
    &quot;&quot;&quot; FloorPlan class derived from nx.DigGraph

    Methods
    -------

    build : recursive construction of floor plan 
    show : show the floor plan 

    &quot;&quot;&quot;

    def __init__(self,rootid,coords,nodes,ways,relations):
        &quot;&quot;&quot; object constructor

        Parameters
        ----------

        rootid
        coords
        nodes
        ways
        relations

        &quot;&quot;&quot;
        nx.DiGraph.__init__(self)
        self.rootid=rootid
        self.coords = coords
        self.nodes = nodes
        self.ways = ways
        self.relations = relations

    def __repr__(self):

        st = str(self.rootid)+&#39;\n&#39;
        levels = nx.neighbors(self,self.rootid)
        st = st + &#39;---&#39;+&#39;\n&#39;
        for l in levels:
            nw = len(nx.neighbors(self,l))
            st = st + str(l)+&#39; : &#39;+ str(nw) + &#39;\n&#39;
        return(st)



<div class="viewcode-block" id="FloorPlan.build"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.FloorPlan.html#pylayers.gis.osmparser.FloorPlan.build">[docs]</a>    def build(self,typ,eid):
        &quot;&quot;&quot; Notes : recursive construction

        Parameters
        ----------

        typ : string
            &#39;relation&#39; | &#39;way&#39; | &#39;node&#39;

        &quot;&quot;&quot;
        if typ==&#39;relation&#39;:
            tags = self.relations.relation[eid][&#39;tags&#39;]
            members  =  self.relations.relation[eid][&#39;members&#39;]
        if typ==&#39;way&#39;:
            tags = self.ways.way[eid].tags
            members  =  self.ways.way[eid].refs
        if typ==&#39;node&#39;:
            try:
                tags = self.nodes.node[eid][&#39;tags&#39;]
            except:
                tags = None
            members = None

        self.add_node(eid,tags=tags,type=typ)
        if members is not None:
            for m in members:
                if typ==&#39;relation&#39;:
                    eidn = m[0]
                    typn = m[1]
                if typ==&#39;way&#39;:
                    eidn = m
                    typn = &#39;node&#39;

                self.add_edge(eid,eidn)
                #self = self.build(typ=typn,eid=eidn)
                self.build(typ=typn,eid=eidn)</div>


<div class="viewcode-block" id="FloorPlan.show"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.FloorPlan.html#pylayers.gis.osmparser.FloorPlan.show">[docs]</a>    def show(self,nid=None,fig=[],ax=[]):
        &quot;&quot;&quot; show the floorplan

        Parameters
        ----------

        nid : int 
        fig : plt.figure 
        ax  : plt.ax

        &quot;&quot;&quot;
        if fig==[]:
            fig = plt.figure()
        elif ax==[]:
            ax = fig.gca()

        if nid ==None:
            nid = self.rootid
        nb = nx.neighbors(self,nid)
        for k in nb:
            #print k,self.node[k][&#39;type&#39;],self.node[k][&#39;tags&#39;]
            if self.node[k][&#39;type&#39;]==&#39;way&#39;:
                fig,ax = self.ways.way[k].show(fig=fig,ax=ax)
            else:
                fig,ax = self.show(k,fig=fig,ax=ax)
        return fig,ax</div></div>
#
#  Functions
#     osmparse
#     getbdg
#
#
<div class="viewcode-block" id="getosm"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.getosm.html#pylayers.gis.osmparser.getosm">[docs]</a>def getosm(address=&#39;Rennes&#39;,latlon=0,dist_m=400,cart=False):
    &quot;&quot;&quot; get osm region from osmapi

    Parameters
    ----------

    address : string 
    latlon : tuple or 0 
    dist_m : float 
    cart : boolean 

    Notes
    -----

    if latlon tuple is precised it has priority over the string 

    &quot;&quot;&quot;

    level_height = 3.45
    rad_to_deg = (180/np.pi)
    deg_to_rad = (np.pi/180)

    if latlon==0:
        place = geo.google(address)
        try:
            lat,lon = place.latlng
        except:
            print place
    else:
        lat = latlon[0]
        lon = latlon[1]

    r_earth = 6370e3
    alpha = (dist_m/r_earth)*rad_to_deg
    Osm = OsmApi()

    #
    # Get Map around the specified coordinates 
    #

    osmmap  = Osm.Map(lon-alpha,lat-alpha,lon+alpha,lat+alpha)

    #print(osmmap)
    
    nodes = Nodes()
    nodes.clean()
    nodes.readmap(osmmap)
   
    coords = Coords()
    coords.clean()
    coords.from_nodes(nodes)

    m = coords.cartesian(cart=cart)

    ways = Ways()
    ways.clean()
    ways.readmap(osmmap,coords)
    
    # list of nodes involved in buildings
    lnodes_id=[]
    for iw in ways.w:
        lnodes_id+=ways.w[iw][0]
    # list of all nodes of coords
    lnodes_id   = np.unique(np.array(lnodes_id))
    lnodes_full = np.unique(np.array(coords.latlon.keys()))
    mask = np.in1d(lnodes_full,lnodes_id,invert=True)
    # nodes not involved in buildings
    lexcluded = lnodes_full[mask]
    coords.filter(lexcluded)
    dpoly={}
    for iw in ways.w:
        ways.way[iw].tags = {}
        # material 
        if ways.w[iw][1].has_key(&#39;material&#39;):
            ways.way[iw].tags[&#39;name&#39;]=ways.w[iw][1][&#39;material&#39;]
        elif ways.w[iw][1].has_key(&#39;building:material&#39;):
            ways.way[iw].tags[&#39;name&#39;]=ways.w[iw][1][&#39;building:material&#39;]
        else:
            ways.way[iw].tags[&#39;name&#39;]=&#39;WALL&#39;
        # height 
        if ways.w[iw][1].has_key(&#39;height&#39;):
            ways.way[iw].tags[&#39;z&#39;]=(0,eval(ways.w[iw][1][&#39;height&#39;]))
        elif ways.w[iw][1].has_key(&#39;building:height&#39;):
            ways.way[iw].tags[&#39;z&#39;]=(0,eval(ways.w[iw][1][&#39;building:height&#39;]))
        elif ways.w[iw][1].has_key(&#39;building:levels&#39;):
            nb_levels = eval(ways.w[iw][1][&#39;building:levels&#39;])
            if type(nb_levels)!=int:
                try:
                    nb_levels=max(nb_levels)
                except:
                    nb_levels=2
            ways.way[iw].tags[&#39;z&#39;]=(0,nb_levels*level_height)
        elif ways.w[iw][1].has_key(&#39;levels&#39;):
            nb_levels = eval(ways.w[iw][1][&#39;levels&#39;])
            if type(nb_levels)!=int:
                try:
                    nb_levels=max(nb_levels)
                except:
                    nb_levels=2
            ways.way[iw].tags[&#39;z&#39;]=(0,nb_levels*level_height)
        else:
            ways.way[iw].tags[&#39;z&#39;]=(0,12)
                          
        ptpoly=[coords.xy[x] for x in ways.w[iw][0]]
        dpoly[iw]=geu.Polygon(ptpoly,vnodes=ways.w[iw][0])
        dpoly[iw].coorddeter()
    return coords,nodes,ways,dpoly,m</div>


<div class="viewcode-block" id="osmparse"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.osmparse.html#pylayers.gis.osmparser.osmparse">[docs]</a>def osmparse(_filename,typ=&#39;indoor&#39;,verbose=False,c=True,n=True,w=True,r=True,cart=False):
    &quot;&quot;&quot; parse osm files

    Parameters
    ----------

    typ : string
        indoor | outdoor 
    verbose : boolean
        default : False
    c : boolean
        read coords
    n : boolean
        read nodes
    w : boolean
        read  ways
    r : booleanif c:
        coords = Coords()
        coords.clean()
        read relations

    Returns
    -------

    coords : Coords
    nodes  : Nodes
    ways   : Ways
    relations : Relations

    &quot;&quot;&quot;

    if ((&#39;/&#39; in _filename) or (&#39;//&#39; in _filename)):
        filename = _filename
    else:
        filename = pyu.getlong(_filename,os.path.join(&#39;gis&#39;,&#39;osm&#39;))
    #
    # Read coords and create basemap converter
    #
    if c:
        coords = Coords()
        coords.clean()
        coords_parser = OSMParser(concurrency=4, coords_callback=coords.coords)
        if verbose:
            print &quot;parsing coords&quot;

        coords_parser.parse(filename)

        m = coords.cartesian(cart=cart)

        if verbose:
            print str(coords.cpt)
    else:
        coords = None
    #
    # Read nodes
    #
    if n:
        nodes = Nodes()
        nodes.clean()
        nodes_parser = OSMParser(concurrency=4, nodes_callback=nodes.nodes)

        if verbose:
            print &quot;parsing nodes&quot;

        nodes_parser.parse(filename)

        if verbose:
            print str(nodes.cpt)
    else:
        nodes = None

    #
    # Read ways
    #
    if w:
        ways = Ways()
        ways.clean()
        if typ==&#39;outdoor&#39;:
            ways_parser = OSMParser(concurrency=4, ways_callback=ways.building)
        if typ==&#39;indoor&#39;:
            ways_parser = OSMParser(concurrency=4, ways_callback=ways.ways)
        if verbose:
            print &quot;parsing ways&quot;
        ways_parser.parse(filename)

        if verbose:
            print str(ways.cpt)

        # convert lat,lon in cartesian
        ways.eval(coords)
    else:
        ways = None

    #
    # Read relations
    #
    if r:
        relations = Relations()
        relations.clean()
        relations_parser = OSMParser(concurrency=4,relations_callback=relations.relations)

        if verbose:
            print &quot;parsing relations&quot;
        relations_parser.parse(filename)

        if verbose:
            print str(relations.cpt)
    else:
        relations = None

    return coords,nodes,ways,relations,m</div>


<div class="viewcode-block" id="extract"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.extract.html#pylayers.gis.osmparser.extract">[docs]</a>def extract(alat,alon,fileosm,fileout):
    &quot;&quot;&quot; extraction of an osm sub region using osmconvert

    Parameters
    ----------

    alat : array of latitude (1xn)
    alon : array of longitude (1xn)
    fileosm : source osm file
    filout  : output osm file

    Returns
    -------

    m : Basemap oject for coordinates conversion



    Notes
    -----

    This function takes two (1xn) arrays of latitude an longitude values
    Calculates extrema of those values.
    Invokes osmconvert script on a source fileosm and extract the
    corresponding zone in the fileout file.

    The functions returns a basemap object for coordinates conversion on this
    file.



    &quot;&quot;&quot;
    latmax = alat.max()
    latmin = alat.min()
    lonmax = alon.max()
    lonmin = alon.min()
    lon_0=(lonmax+lonmin)/2
    lat_0=(latmax+latmin)/2

    command = &#39;osmconvert -b=&#39;+str(lonmin)+&#39;,&#39;\
            + str(latmin)+&#39;,&#39;+str(lonmax)+&#39;,&#39;\
            + str(latmax)+&#39; &#39;+fileosm +&#39; &gt; &#39;+ fileout+&#39;.osm&#39;
    print command
    os.system(command)

    m = Basemap(llcrnrlon=lonmin,llcrnrlat=latmin,urcrnrlon=lonmax,urcrnrlat=latmax,
            resolution=&#39;i&#39;,projection=&#39;cass&#39;,lon_0=lon_0,lat_0=lat_0)

    return(m)</div>

<div class="viewcode-block" id="getbdg"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.getbdg.html#pylayers.gis.osmparser.getbdg">[docs]</a>def getbdg(fileosm,verbose=False):
    &quot;&quot;&quot; get building from osm file

    Parameters
    ----------

    fileosm : string

    Returns
    -------

    zone : list of Polygon

    &quot;&quot;&quot;

    coords,nodes,ways,relation,m = osmparse(fileosm,typ=&#39;outdoor&#39;,verbose=verbose)
    zone = []
    for w in ways.way:
        zone.append(ways.way[w].shp)
    return(zone)</div>

<div class="viewcode-block" id="buildingsparse"><a class="viewcode-back" href="../../../api/pylayers.gis.osmparser.buildingsparse.html#pylayers.gis.osmparser.buildingsparse">[docs]</a>def buildingsparse(filename):
    &quot;&quot;&quot; parse buildings

    Parameters
    ----------

    filename : string

    &quot;&quot;&quot;
    coords,nodes,ways,relations,m = osmparse(filename)
    for bid in relations.relation:
        tags = relations.relation[bid][&#39;tags&#39;]
        if tags[&#39;type&#39;]==&#39;outdoor&#39;:
            print &quot;Constructing Indoor building &quot;, bid
            bdg = FloorPlan(bid,coords,nodes,ways,relations)
            bdg.build(typ=&#39;relation&#39;,eid=bid)
    return bdg,m</div>

</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, PyLayers developer team.
      Last updated on Dec 01, 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>